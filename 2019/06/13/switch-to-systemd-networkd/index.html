<!doctype html><html lang=zh-hans><!doctype html><html><head><title>从 netctl 切换到 systemd-networkd</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="A blog maintained by an interesting programmer."><meta name=keywords content="Technology,Code,Program,Linux,"><meta name=author content="Xuanwo"><meta property="og:title" content="从 netctl 切换到 systemd-networkd"><meta property="og:description" content="A blog maintained by an interesting programmer."><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://xuanwo.io/2019/06/13/switch-to-systemd-networkd/"><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.2/themes/algolia-min.css integrity="sha256-HB49n/BZjuqiCtQQf49OdZn63XuKFaxcIHWf0HNKte8=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.46a76e3a73d0dcdaf41bcf3511d9eb58e76e4677c1b8737198bdb5229d7be072.css integrity="sha256-RqduOnPQ3Nr0G881EdnrWOduRnfBuHNxmL21Ip174HI="><script defer src=/javascript/fontawesome.min.a066b72a16bb5f37fe57ab06f6409b5bf30239d82ab5a71987e6abcac78bf2f0.js integrity=sha256-oGa3Kha7Xzf+V6sG9kCbW/MCOdgqtacZh+aryseL8vA=></script><link href=http://gmpg.org/xfn/11 rel=profile><meta name=generator content="Hugo 0.72.0"></head><body class="min-h-full font-sans leading-normal"><header><nav class="container text-gray px-4"><div class="py-2 flex flex-col lg:flex-row flex-wrap justify-between items-center"><a class="text-2xl text-gray-900 hover:no-underline flex-shrink-0 font-normal" href=/>漩涡的博客</a><div class="flex flex-col lg:flex-row items-center w-full lg:w-auto"><a class="header-link flex-shrink-0 hover:no-underline hover:text-grey-700 relative mr-0 lg:mr-8 my-2 lg:my-0 text-gray-500" href=/about/>关于我</a>
<a class="header-link flex-shrink-0 hover:no-underline hover:text-grey-700 relative mr-0 lg:mr-8 my-2 lg:my-0 text-gray-500" href=/en-us/>English Version</a><div class=relative><span class=algolia-autocomplete style=position:relative;display:inline-block;direction:ltr><input id=search-box class="transition-colors duration-100 ease-in-out focus:outline-0 border border-transparent focus:bg-white focus:border-gray-300 placeholder-gray-500 rounded-lg bg-gray-200 py-2 pr-4 pl-10 block w-full appearance-none leading-normal ds-input" type=text autocomplete=off spellcheck=false role=combobox dir=auto style=position:relative;vertical-align:top></span><div class="pointer-events-none absolute inset-y-0 left-0 pl-4 flex items-center"><svg class="fill-current pointer-events-none text-gray-600 w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.9 14.32a8 8 0 111.41-1.41l5.35 5.33-1.42 1.42-5.33-5.34zM8 14A6 6 0 108 2a6 6 0 000 12z"/></svg></div></div></div></div></nav></header><main class="flex-1 px-4"><article class="container pt-16"><header class="pb-4 mb-8 border-b"><h1 class="my-2 text-black leading-tight">从 netctl 切换到 systemd-networkd</h1><ul class="mb-0 pb-0 text-sm text-grey-500"><li class="block sm:inline-block mr-3"><time class="text-lg font-light" datetime=2019-06-13T01:00:00.000+00:00 itemprop=datePublished>2019-06-13</time></li><li class="block sm:inline-block mr-3"><a class="text-lg font-light" href=https://xuanwo.io/tags/systemd><span>#systemd</span></a>
<a class="text-lg font-light" href=https://xuanwo.io/tags/archlinux><span>#archlinux</span></a></li></ul></header><div class=post-content><p>晚上的时候临时起意决定把网络管理器从 <code>netctl</code> 切换到 <code>systemd-networkd</code>，切换的过程意外的顺畅。本文记录了一下切换的过程并简单介绍一下 <code>systemd-networkd</code> + <code>iwd</code> 的组合如何使用。</p><hr><h2 id=出场人物介绍>出场人物介绍</h2><h3 id=netctl>netctl</h3><p>netctl 是 archlinux 的亲儿子，上游就在 <a href=https://git.archlinux.org/netctl.git/>https://git.archlinux.org/netctl.git/</a>，也是除了 <code>systemd-networkd</code> 之外（这是 systemd 钦定的），唯一一个进入 base 组的网络管理工具，说是官方钦定也不为过。netcl 依赖 dhcpcd 或者 dhclient 来获取动态 IP 地址，通过 <code>wpa_supplicant</code> 来访问加密的 WiFi，提供了 <code>wifi-menu</code> 供用户在命令行下交互式地选择热点并输入密码。同时还提供了一系列的 systemd service 文件（<code>netctl@.service</code>，<code>netctl-ifplugd@.service</code>，<code>netctl-auto@.service</code>）来帮助用户进行配置，比如在开启了 <code>netctl-auto@&lt;interface>.service</code> 之后，你的网卡就能在可选的 profile 中自动切换。</p><h3 id=systemd-networkd>systemd-networkd</h3><p>正如它的名字所暗示的，这是 systemd 全家桶的一员。它主要负责的是检测并配置网络设备，特别的是它还能够用来配置 <code>systemd-nspawn</code> 启动的容器的网络。</p><h3 id=iwd>iwd</h3><p>iwd (iNet wireless daemon) 是 Intel 开发，用于取代 <code>wpa_supplicant</code> 的 WiFi 后端。它的主要目标是通过不依赖任何外部库而是最大限度的利用 Linux 内核提供的功能来优化资源利用率。iwd 可以很好的跟 systemd-network 配合使用。</p><h2 id=使用场景介绍>使用场景介绍</h2><p>平时只需要连接 3 个 Wi-Fi：家里的，公司的，手机的，没有频繁切换/增加/修改/删除 Wi-Fi 配置的需求，所以我不需要一个常驻通知区域的服务来进行切换。此外，我的 VPN 已经全部通过 systemd 来进行管理了，所以也不需要网络管理工具替我做这些操作。我需要的是这样的一个工具组合：一个负责管理网络设备，一个负责连接 WiFi 并进行认证。之前的组合是 <code>netctl</code> + <code>wpa_supplicant</code>，现在我有了新欢：<code>systemd-networkd</code> + <code>iwd</code>。</p><h2 id=如何使用>如何使用</h2><h3 id=停用-netctl>停用 netctl</h3><p>首先需要停用 netctl 的相关服务，避免多个网络管理工具在一起打架。</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> systemctl stop netctl-auto@&lt;interface&gt;.service
:<span style=color:#666>)</span> systemctl disable netctl-auto@&lt;interface&gt;.service
</code></pre></div><h3 id=配置网卡>配置网卡</h3><p>然后按照 Wiki 的指示写无线网卡的配置，放在 <code>/etc/systemd/network</code> 下。</p><p>对无线网卡来说，最小化的配置是这样的：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#007020;font-weight:700>[Match]</span>
<span style=color:#4070a0>Name</span><span style=color:#666>=</span><span style=color:#4070a0>wlp2s0</span>

<span style=color:#007020;font-weight:700>[Network]</span>
<span style=color:#4070a0>DHCP</span><span style=color:#666>=</span><span style=color:#4070a0>ipv4</span>
</code></pre></div><ul><li><code>Match</code> 主要是用于匹配管理的设备，可以通过设备名，MAC 地址等来选择</li><li><code>Network</code> 用来做网络相关的具体配置，比如 DHCP，DNS 等</li></ul><p>我的本地开启了 coredns 作为 DNS 服务，所以我需要额外加一些配置来通过 DHCP 来获取 IPv4 地址，但是不使用 DHCP 下发的 DNS。</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#007020;font-weight:700>[Match]</span>
<span style=color:#4070a0>Name</span><span style=color:#666>=</span><span style=color:#4070a0>wlan0</span>

<span style=color:#007020;font-weight:700>[Network]</span>
<span style=color:#4070a0>DHCP</span><span style=color:#666>=</span><span style=color:#4070a0>ipv4</span>
<span style=color:#4070a0>DNS</span><span style=color:#666>=</span><span style=color:#4070a0>127.0.0.1</span>

<span style=color:#007020;font-weight:700>[DHCP]</span>
<span style=color:#4070a0>UseDNS</span><span style=color:#666>=</span><span style=color:#4070a0>false</span>
</code></pre></div><blockquote><p>iwd 启动的时候似乎会修改网络设备的名字，我的网卡被修改成了 wlan0</p></blockquote><p>在配置写好之后就可以启动 <code>systemd-networkd</code> 的服务啦：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> systemctl start systemd-netword
</code></pre></div><p>如果修改了网络配置，只需要 restrart 即可。</p><p>更具体的配置可以参阅 ArchWiki 或者 <code>man systemd-networkd</code>。</p><h3 id=配置-iwd>配置 iwd</h3><p>iwd 不是自带的软件包，所以首先需要自行安装：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> pacman -S iwd
</code></pre></div><p>在开始使用之前，我们需要 start 并且 enable iwd 服务：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> systemctl start iwd
:<span style=color:#666>)</span> systemctl <span style=color:#007020>enable</span> iwd
</code></pre></div><p>然后就可以用 <code>iwctl</code> 进行管理啦，iwctl 默认会进入一个交互式的命令行界面，使用体验还是很赞的：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> iwctl
<span style=color:#666>[</span>iwd<span style=color:#666>]</span>#
</code></pre></div><p>此时输入 help 会返回支持的所有命令，各个命令都比较直观，只要对 WiFi 的相关技术名词稍有了解就能很快上手，此外这个界面所有命令都支持自动补全，好评。</p><p>首先先看看我们有哪些设备：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#666>[</span>iwd<span style=color:#666>]</span><span style=color:#60a0b0;font-style:italic># device list</span>
Devices                                   *
--------------------------------------------------------------------------------
Name                Address             Powered   Adapter   Mode
--------------------------------------------------------------------------------
wlan0               xx:xx:xx:xx:xx:xx   on        phy0      station
</code></pre></div><p>这个界面是动态的，右上角的 <code>*</code> 会不断闪烁表明这个界面是实时的。</p><p>然后我们可以手动触发一次 STA 扫描：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#666>[</span>iwd<span style=color:#666>]</span><span style=color:#60a0b0;font-style:italic># station wlan0 scan</span>
</code></pre></div><p>之后就可以查看有哪些能连接 WiFi 热点了：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#666>[</span>iwd<span style=color:#666>]</span><span style=color:#60a0b0;font-style:italic># station wlan0 get-networks</span>
                               Available networks                             *
--------------------------------------------------------------------------------
    Network name                    Security  Signal
--------------------------------------------------------------------------------
    CU_SNZQ                         psk       ****
    xjzy                            psk       ****
    Tenda_30BDD0                    psk       ****
    TP-LINK_D82B80                  psk       ****
    TP-LINK_lee                     psk       ****
    ziroom201                       psk       ****
    mhshome                         psk       ****
    TP-LINK_he                      psk       ****
    TP-LINK_450C                    psk       ****
    yuzhe                           psk       ****
    z212-202                        psk       ****
    Bill<span>&#39;</span>s Router                   psk       ****
    tcs                             psk       ****
  &gt; XXXXXXXXXXX                     psk       ****
</code></pre></div><p>这个界面同样是动态的，可以查看当前能连接网络机器信号强度。</p><p>最后就能够选择想要连接 SSID 连接网络了，如果需要输入密码的话，iwd 还会出现一个提示要求输入密码。</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#666>[</span>iwd<span style=color:#666>]</span><span style=color:#60a0b0;font-style:italic># station wlan0 connect XXXXXXXXXXX</span>
</code></pre></div><p>这里有个需要提出来的点：iwd 通过交互式界面成功连接上网络之后，就会自动的在 <code>/var/lib/iwd</code> 下生成对应的配置文件，之后 iwd 自动的进行连接。所以一方面是不需要自己手动的去写配置文件，另一方面是切换过程也是自动的，不需要人工干预。</p><p>iwd 生成的配置文件名是有一定规则的，用 SSID 作为文件名，然后以加密方式作为后缀，比如 <code>*.open</code> 表示这是一个开放网络，<code>*.psk</code> 表示这是一个使用 PSK 加密的网络。</p><h3 id=检查状态>检查状态</h3><p>全部配置好之后可以分别查看一下 WiFi 和网卡的状态：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> iwctl device wlan0 show
                                 Device: wlan0
--------------------------------------------------------------------------------
  Settable  Property            Value
--------------------------------------------------------------------------------
            Name                wlan0
         *  Mode                station
         *  Powered             on
            Address             xx:xx:xx:xx:xx:xx
         *  WDS                 off
            Adapter             phy0
:<span style=color:#666>)</span> networkctl status
●        State: routable
       Address: 192.168.0.103 on wlan0
                xxxx::xxxx:xxxx:xxxx:xxxx on wlan0
       Gateway: 192.168.0.1 <span style=color:#666>(</span>TP-LINK TECHNOLOGIES CO.,LTD.<span style=color:#666>)</span> on wlan0
           DNS: 127.0.0.1
</code></pre></div><h2 id=总结>总结</h2><p>systemd 真香，上交底裤我光荣！天灭 networkmanager ！</p><h2 id=参考资料>参考资料</h2><ul><li><a href=https://wiki.archlinux.org/index.php/Systemd-networkd>systemd-networkd - ArchWiki</a></li><li><a href=https://wiki.archlinux.org/index.php/Iwd>iwd - ArchWiki</a></li></ul></div></article></main><footer><div class="container px-4"><div class="flex flex-col md:flex-row justify-between py-4"><div class="flex-shrink-0 flex flex-wrap md:w-1/3 mt-4 md:mt-0"><span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/archives/>归档</a></span>
<span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/categories/>分类</a></span>
<span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/tags/>标签</a></span>
<span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/series/>系列</a></span>
<span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/blogroll/>友链</a></span></div><ul class="flex sm:w-1/2 md:w-1/3 text-center lg:text-right"><li class=w-1/4><a class="text-gray-500 hover:text-gray-800" href=/index.xml><i class="fas fa-rss"></i></a></li><li class=w-1/4><a class="text-gray-500 hover:text-gray-800" href=https://github.com/Xuanwo><i class="fas fa-github"></i></a></li><li class=w-1/4><a class="text-gray-500 hover:text-gray-800" href=https://t.me/xuanwo_read_later><i class="fas fa-telegram-plane"></i></a></li><li class=w-1/4><a class="text-gray-500 hover:text-gray-800" href=https://twitter.com/OnlyXuanwo><i class="fas fa-twitter"></i></a></li></ul></div></div><script src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.js integrity="sha256-KiHRWUnyloQ6hvdcRAfi7hwExmviOdyWTRFBLmDNhHc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js integrity="sha256-YVWQosorZnr6fALvOW9VALYuInld27RkSPkElGBdCaU=" crossorigin=anonymous></script><script defer src=/javascript/algolia_search.min.78d1e38d6ad73f7bc248762cbf4f70b246476baa3288e2a780ec7ac11f0e669d.js integrity=sha256-eNHjjWrXP3vCSHYsv09wskZHa6oyiOKngOx6wR8OZp0=></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-51515330-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></footer></body></html>