<!doctype html><html lang=zh-hans><!doctype html><html><head><title>go-mime 介绍以及踩坑记录</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="A blog maintained by an interesting programmer."><meta name=keywords content="Technology,Code,Program,Linux,"><meta name=author content="Xuanwo"><meta property="og:title" content="go-mime 介绍以及踩坑记录"><meta property="og:description" content="A blog maintained by an interesting programmer."><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://xuanwo.io/2020/04-go-mime-intro/"><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.2/themes/algolia-min.css integrity="sha256-HB49n/BZjuqiCtQQf49OdZn63XuKFaxcIHWf0HNKte8=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.86011fe2120272b15cfe4299381bebaf7719f960a0f6117c9397371547aaeb2a.css integrity="sha256-hgEf4hICcrFc/kKZOBvrr3cZ+WCg9hF8k5c3FUeq6yo="><script defer src=/javascript/fontawesome.min.a066b72a16bb5f37fe57ab06f6409b5bf30239d82ab5a71987e6abcac78bf2f0.js integrity=sha256-oGa3Kha7Xzf+V6sG9kCbW/MCOdgqtacZh+aryseL8vA=></script><link href=http://gmpg.org/xfn/11 rel=profile><meta name=generator content="Hugo 0.72.0"></head><body class="min-h-screen font-sans leading-normal"><header><nav class="container text-gray"><div class="py-2 flex flex-col lg:flex-row flex-wrap justify-between items-center"><a class="text-2xl text-gray-900 hover:no-underline flex-shrink-0 font-normal" href=/>漩涡的博客</a><div class="flex flex-col lg:flex-row items-center w-full lg:w-auto"><a class="header-link flex-shrink-0 hover:no-underline hover:text-grey-700 relative mr-0 lg:mr-8 my-2 lg:my-0 text-gray-500" href=/about/>关于我</a>
<a class="header-link flex-shrink-0 hover:no-underline hover:text-grey-700 relative mr-0 lg:mr-8 my-2 lg:my-0 text-gray-500" href=/en-us/>English Version</a><div class=relative><span class=algolia-autocomplete style=position:relative;display:inline-block;direction:ltr><input id=search-box class="transition-colors duration-100 ease-in-out focus:outline-0 border border-transparent focus:bg-white focus:border-gray-300 placeholder-gray-500 rounded-lg bg-gray-200 py-2 pr-4 pl-10 block w-full appearance-none leading-normal ds-input" type=text autocomplete=off spellcheck=false role=combobox dir=auto style=position:relative;vertical-align:top></span><div class="pointer-events-none absolute inset-y-0 left-0 pl-4 flex items-center"><svg class="fill-current pointer-events-none text-gray-600 w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.9 14.32a8 8 0 111.41-1.41l5.35 5.33-1.42 1.42-5.33-5.34zM8 14A6 6 0 108 2a6 6 0 000 12z"/></svg></div></div></div></div></nav></header><main class=flex-1><article class="container pt-16"><header class="pb-4 mb-8 border-b"><h1 class="my-2 text-black leading-tight">go-mime 介绍以及踩坑记录</h1><ul class="mb-0 pb-0 text-sm text-grey-500"><li class="block sm:inline-block mr-3"><time class="text-lg font-light" datetime=2020-06-01T01:00:00.000+00:00 itemprop=datePublished>2020-06-01</time></li><li class="block sm:inline-block mr-3"></li></ul></header><div class=post-content><p>上周花了一天时间写了一个 <a href=https://github.com/qingstor/go-mime>MIME 检测</a> 的库，作用是能够根据后缀名来检测对应的 Media Type 类型，比如说输入 <code>pdf</code> 能够返回 <code>application/pdf</code>。本文介绍一下这个库以及开发过程中的踩坑记录。</p><h2 id=背景>背景</h2><p>服务器端检测文件 <code>Media Type</code> （之前经常被叫做 <code>MIME types</code>）的方法通常有三种：第一是看请求中携带的 <code>content-type</code>，第二是读取文件开头的 <code>Magic Number</code>，第三则是看请求中携带的文件名。</p><p>其中只有第一种根据 <code>content-type</code> 判断是在 <a href=https://tools.ietf.org/html/rfc7231#section-3.1.1.5>RFC7273</a> 中标准化过的行为，剩下的两种都是约定俗成：提供/使用这种 <code>Media Type</code> 的软件/服务自行规定 <code>Magic Number</code> 和后缀名。</p><p>以常见的 PDF 为例，它的 <code>Media Type</code> 模板中会有这样的内容：</p><pre><code>Magic number(s): All PDF files start with the characters &quot;%PDF-&quot;
followed by the PDF version number, e.g., &quot;%PDF-1.7&quot; or
&quot;%PDF-2.0&quot;.  These characters are in US-ASCII encoding.

File extension(s): .pdf
</code></pre><p>这些是在 PDF 相关的 <a href=https://tools.ietf.org/html/rfc8118>RFC 8188: The application/pdf Media Type</a> 中规定的，考虑的比较周到，不管是 <code>Magic Number</code> 还是文件后缀名都给出了明确的说明。</p><p>而根据 <a href=https://www.rfc-editor.org/info/bcp13>BCP 13</a>，任何人和组织都能够注册 <code>Media Type</code>，因此文件后缀名撞车也是常有的事情，尤其是在 <code>vnd.</code> 前缀下的 <code>Media Type</code>，我也数不清有多少 <code>Media Type</code> 注册了 <code>json</code> 和 <code>xml</code>。还有很多 <code>Media Type</code> 没有注册 <code>Magic Number</code>，其中有大部分是纯文本类型。</p><p>所以 <code>Meida Type</code> 与文件后缀名和 <code>Magic Number</code> 之间并没有明确的一一映射，大家只能自行归纳和整理，这也是为什么每个操作系统和语言都有一套自己的 <code>mime-types</code> 集。</p><p>其中 golang 的实现是自己有一个比较小的内置类型映射：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#007020;font-weight:700>var</span> builtinTypesLower = <span style=color:#007020;font-weight:700>map</span>[<span style=color:#902000>string</span>]<span style=color:#902000>string</span>{
	<span style=color:#4070a0>&#34;.css&#34;</span>:  <span style=color:#4070a0>&#34;text/css; charset=utf-8&#34;</span>,
	<span style=color:#4070a0>&#34;.gif&#34;</span>:  <span style=color:#4070a0>&#34;image/gif&#34;</span>,
	<span style=color:#4070a0>&#34;.htm&#34;</span>:  <span style=color:#4070a0>&#34;text/html; charset=utf-8&#34;</span>,
	<span style=color:#4070a0>&#34;.html&#34;</span>: <span style=color:#4070a0>&#34;text/html; charset=utf-8&#34;</span>,
	<span style=color:#4070a0>&#34;.jpeg&#34;</span>: <span style=color:#4070a0>&#34;image/jpeg&#34;</span>,
	<span style=color:#4070a0>&#34;.jpg&#34;</span>:  <span style=color:#4070a0>&#34;image/jpeg&#34;</span>,
	<span style=color:#4070a0>&#34;.js&#34;</span>:   <span style=color:#4070a0>&#34;text/javascript; charset=utf-8&#34;</span>,
	<span style=color:#4070a0>&#34;.mjs&#34;</span>:  <span style=color:#4070a0>&#34;text/javascript; charset=utf-8&#34;</span>,
	<span style=color:#4070a0>&#34;.pdf&#34;</span>:  <span style=color:#4070a0>&#34;application/pdf&#34;</span>,
	<span style=color:#4070a0>&#34;.png&#34;</span>:  <span style=color:#4070a0>&#34;image/png&#34;</span>,
	<span style=color:#4070a0>&#34;.svg&#34;</span>:  <span style=color:#4070a0>&#34;image/svg+xml&#34;</span>,
	<span style=color:#4070a0>&#34;.wasm&#34;</span>: <span style=color:#4070a0>&#34;application/wasm&#34;</span>,
	<span style=color:#4070a0>&#34;.webp&#34;</span>: <span style=color:#4070a0>&#34;image/webp&#34;</span>,
	<span style=color:#4070a0>&#34;.xml&#34;</span>:  <span style=color:#4070a0>&#34;text/xml; charset=utf-8&#34;</span>,
}
</code></pre></div><p>除此之外的类型会读取系统中以下三个文件：</p><ul><li><code>/etc/mime.types</code></li><li><code>/etc/apache2/mime.types</code></li><li><code>/etc/apache/mime.types</code></li></ul><h2 id=问题>问题</h2><p>用户在调用 <code>Pub Object</code> 等 API 的时候如果没有指定 <code>content-type</code> 的话，服务器端会根据文件后缀名来尝试检测对应的 <code>Media Type</code>。之前的实现是使用 go 自带的 <a href=https://golang.org/pkg/mime/><code>mime</code></a> 包，但是在测试中遇到了相同文件后缀返回的 <code>Media Type</code> 不一致的问题。经过排查后发现是服务器上的 <code>/etc/mime.types</code> 文件不一致，有些节点安装了对应的包，有些则没有。避免这种不一致最好的方式不要依赖系统提供这个文件，因此我们决定替换掉 <code>mime</code> 包，改成自己的实现。</p><p>看了下社区的实现，主要有以下两个：</p><p><a href=https://github.com/cubewise-code/go-mime>cubewise-code/go-mime</a></p><p>数据源来自 <a href=https://github.com/micnic/mime.json>micnic/mime.json</a>，而 <code>micnic/mime.json</code> 提取自一个 Node.js 社区的项目 <a href=https://github.com/jshttp/mime-db>jshttp/mime-db</a>。功能上能够满足我们的需求，但是维护的质量堪忧，用于生成 <code>mimeTypes</code> 的代码并没有一并开源出来（虽然肯定非常简单）。原始数据也倒了很多层次，一方面是增加了出错的可能性，另一方面是影响更新的及时性。</p><p><a href=https://github.com/gabriel-vasile/mimetype>gabriel-vasile/mimetype</a></p><p>看起来比上一个好不少，但是这个库专注于通过 <code>Magic Number</code> 来判断文件的 <code>Media Type</code>，而我们的业务场景决定了我们不能读取用户上传的数据来获取 <code>Magic Number</code>。此外这个库只支持了少量文件类型（147 种），数据源也不是非常明确。</p><p>所以需要自己造一个轮子。</p><h2 id=设计>设计</h2><p>我们需要一个这样的 <code>MIME</code> 库：</p><ul><li>没有第三方依赖</li><li>不依赖系统行为</li><li>尽可能直接处理原始数据</li><li>支持多种方式检测（首先支持文件后缀名）</li></ul><p>最难的地方在于找到合适的数据源。正如前面所提到的，当今的各种规范中都没有明确定义 <code>Media Type</code> 到文件后缀名的一一映射。经过一番搜寻之后，只能找到如下相对可信的来源：</p><ul><li><a href=https://www.iana.org/assignments/media-types/media-types.xhtml>IANA Media Types</a></li><li><a href=http://hg.nginx.org/nginx/file/tip/conf/mime.types>Nginx conf/mime.types</a></li><li><a href=http://svn.apache.org/repos/asf/httpd/httpd/trunk/docs/conf/mime.types>Apache httpd docs/conf/mime.types</a></li><li><a href=https://pagure.io/mailcap/blob/master/f/mime.types>mailcap mime.types</a></li></ul><p>其中很多发行版会使用 <code>mailcap</code> 提供的 <code>mime.types</code> 作为 <code>/etc/mime.types</code>，已知的有 <a href=https://www.archlinux.org/packages/extra/any/mailcap/>archlinux</a>。</p><p>所以最后决定第一期解析 IANA 的 <code>Media Type Template</code> 和 <code>mailcap</code> 提供的 <code>mime.types</code> 并生成一个 <code>map[&lt;file-extension>]&lt;media-type></code>。</p><h2 id=实现>实现</h2><p>具体的实现没有什么值得说的，值得一提的是 IANA Media Types Registry 中居然还有个 template 404 了，好在他们的响应速度还挺快的，周五给他们发了邮件，周日就 Fix 了。</p><blockquote><p>我真心觉得 IANA 应该尽快采用结构化数据，这 Meida Type Template 也太傻了。。</p></blockquote><h2 id=showtime>Showtime</h2><p>目前 <code>go-mime</code> 只提供了两个接口：<code>DetectFileExt</code> 和 <code>DetectFilePath</code>。</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#007020;font-weight:700>import</span> (
    <span style=color:#4070a0>&#34;github.com/qingstor/go-mime&#34;</span>
)

<span style=color:#007020;font-weight:700>func</span> <span style=color:#06287e>main</span>()  {
    <span style=color:#60a0b0;font-style:italic>// Get mime type via file extension.
</span><span style=color:#60a0b0;font-style:italic></span>    mimeType <span style=color:#666>:=</span> mime.<span style=color:#06287e>DetectFileExt</span>(<span style=color:#4070a0>&#34;pdf&#34;</span>)
    <span style=color:#60a0b0;font-style:italic>// Get mime type via file path or name.
</span><span style=color:#60a0b0;font-style:italic></span>    mimeType <span style=color:#666>:=</span> mime.<span style=color:#06287e>DetectFilePath</span>(<span style=color:#4070a0>&#34;/srv/http/a.pdf&#34;</span>)
}
</code></pre></div><p>做了一些简单的 Benchmark：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>goos: linux
goarch: amd64
pkg: github.com<span style=color:#666>/</span>qingstor<span style=color:#666>/</span><span style=color:#007020;font-weight:700>go</span><span style=color:#666>-</span>mime
BenchmarkDetectFilePath
BenchmarkDetectFilePath<span style=color:#666>-</span><span style=color:#40a070>8</span>                	<span style=color:#40a070>64920656</span>	        <span style=color:#40a070>18.1</span> ns<span style=color:#666>/</span>op
BenchmarkDetectFileExt
BenchmarkDetectFileExt<span style=color:#666>-</span><span style=color:#40a070>8</span>                 	<span style=color:#40a070>98209147</span>	        <span style=color:#40a070>10.9</span> ns<span style=color:#666>/</span>op
BenchmarkDetectFileExtWithMissingExt
BenchmarkDetectFileExtWithMissingExt<span style=color:#666>-</span><span style=color:#40a070>8</span>   	<span style=color:#40a070>98105074</span>	        <span style=color:#40a070>11.8</span> ns<span style=color:#666>/</span>op
BenchmarkGoMime
BenchmarkGoMime<span style=color:#666>-</span><span style=color:#40a070>8</span>                        	<span style=color:#40a070>25084992</span>	        <span style=color:#40a070>47.7</span> ns<span style=color:#666>/</span>op
BenchmarkGoMimeWithMissingExt
BenchmarkGoMimeWithMissingExt<span style=color:#666>-</span><span style=color:#40a070>8</span>          	<span style=color:#40a070>10683265</span>	       <span style=color:#40a070>104</span> ns<span style=color:#666>/</span>op
PASS
</code></pre></div><h2 id=下一步规划>下一步规划</h2><p>目前只实现了最基础的功能，接下来考虑在以下的方面做一些改进</p><ul><li>目前的 Generator 实现比较难看，之后考虑重构的更加清晰</li><li>支持读取 <code>Magic Number</code>，多种方式判断</li><li>支持 <code>Media Type Parameters</code>，比如说 <code>charset</code></li><li>支持给定 <code>Media Type</code> 返回可能的文件后缀名</li></ul><h2 id=参考资料>参考资料</h2><ul><li><a href=https://tools.ietf.org/html/rfc7231#section-3.1.1.5>RFC 7273</a> 中规定的 HTTP Header Content-Type</li><li><a href=https://tools.ietf.org/html/rfc8118>The application/pdf Media Type</a> 中规定了 PDF 的 <code>Media Type</code></li><li><a href=https://www.rfc-editor.org/info/bcp13>BCP 13</a> 包括两个 RFC：<a href=https://tools.ietf.org/html/rfc6838>RFC 6838: Media Type Specifications and Registration Procedures</a> 和 <a href=https://tools.ietf.org/html/rfc4289>RFC 4289</a></li></ul></div></article></main><footer><div class=container><div class="flex flex-col md:flex-row justify-between py-4"><div class="flex-shrink-0 flex flex-wrap md:w-1/3 mt-4 md:mt-0"><span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/archives/>归档</a></span>
<span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/categories/>分类</a></span>
<span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/tags/>标签</a></span>
<span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/series/>系列</a></span>
<span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/blogroll/>友链</a></span></div><ul class="flex sm:w-1/2 md:w-1/3 text-center lg:text-right"><li class=w-1/4><a class="text-gray-500 hover:text-gray-800" href=/index.xml><i class="fas fa-rss"></i></a></li><li class=w-1/4><a class="text-gray-500 hover:text-gray-800" href=https://github.com/Xuanwo><i class="fas fa-github"></i></a></li><li class=w-1/4><a class="text-gray-500 hover:text-gray-800" href=https://t.me/xuanwo_read_later><i class="fas fa-telegram-plane"></i></a></li><li class=w-1/4><a class="text-gray-500 hover:text-gray-800" href=https://twitter.com/OnlyXuanwo><i class="fas fa-twitter"></i></a></li></ul></div></div><script src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.js integrity="sha256-KiHRWUnyloQ6hvdcRAfi7hwExmviOdyWTRFBLmDNhHc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js integrity="sha256-YVWQosorZnr6fALvOW9VALYuInld27RkSPkElGBdCaU=" crossorigin=anonymous></script><script defer src=/javascript/algolia_search.min.78d1e38d6ad73f7bc248762cbf4f70b246476baa3288e2a780ec7ac11f0e669d.js integrity=sha256-eNHjjWrXP3vCSHYsv09wskZHa6oyiOKngOx6wR8OZp0=></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-51515330-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></footer></body></html>