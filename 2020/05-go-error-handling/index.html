<!doctype html><html lang=zh-hans><!doctype html><html><head><title>(我的) Golang 错误处理最佳实践</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="A blog maintained by an interesting programmer."><meta name=keywords content="Technology,Code,Program,Linux,"><meta name=author content="Xuanwo"><meta property="og:title" content="(我的) Golang 错误处理最佳实践"><meta property="og:description" content="A blog maintained by an interesting programmer."><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://xuanwo.io/2020/05-go-error-handling/"><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.2/themes/algolia-min.css integrity="sha256-HB49n/BZjuqiCtQQf49OdZn63XuKFaxcIHWf0HNKte8=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.bc4f7de29e73073ccb91716b28e0dc314f9a0947c8f0977cc0e159a1c7f01a6c.css integrity="sha256-vE994p5zBzzLkXFrKODcMU+aCUfI8Jd8wOFZocfwGmw="><script defer src=/javascript/fontawesome.min.a066b72a16bb5f37fe57ab06f6409b5bf30239d82ab5a71987e6abcac78bf2f0.js integrity=sha256-oGa3Kha7Xzf+V6sG9kCbW/MCOdgqtacZh+aryseL8vA=></script><link href=http://gmpg.org/xfn/11 rel=profile><meta name=generator content="Hugo 0.72.0"></head><body class="min-h-full font-sans leading-normal"><header><nav class="container text-gray"><div class="py-2 flex flex-col lg:flex-row flex-wrap justify-between items-center"><a class="text-2xl text-gray-900 hover:no-underline flex-shrink-0 font-normal" href=/>漩涡的博客</a><div class="flex flex-col lg:flex-row items-center w-full lg:w-auto"><a class="header-link flex-shrink-0 hover:no-underline hover:text-grey-700 relative mr-0 lg:mr-8 my-2 lg:my-0 text-gray-500" href=/about/>关于我</a>
<a class="header-link flex-shrink-0 hover:no-underline hover:text-grey-700 relative mr-0 lg:mr-8 my-2 lg:my-0 text-gray-500" href=/en-us/>English Version</a><div class=relative><span class=algolia-autocomplete style=position:relative;display:inline-block;direction:ltr><input id=search-box class="transition-colors duration-100 ease-in-out focus:outline-0 border border-transparent focus:bg-white focus:border-gray-300 placeholder-gray-500 rounded-lg bg-gray-200 py-2 pr-4 pl-10 block w-full appearance-none leading-normal ds-input" type=text autocomplete=off spellcheck=false role=combobox dir=auto style=position:relative;vertical-align:top></span><div class="pointer-events-none absolute inset-y-0 left-0 pl-4 flex items-center"><svg class="fill-current pointer-events-none text-gray-600 w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.9 14.32a8 8 0 111.41-1.41l5.35 5.33-1.42 1.42-5.33-5.34zM8 14A6 6 0 108 2a6 6 0 000 12z"/></svg></div></div></div></div></nav></header><main class="container flex-1 px-4 lg:px-0"><article class="container pt-16"><header class="pb-4 mb-8 border-b"><h1 class="my-2 text-black leading-tight">(我的) Golang 错误处理最佳实践</h1><ul class="mb-0 pb-0 text-sm text-grey-500"><li class="block sm:inline-block mr-3"><time class="text-lg font-light" datetime=2020-06-14T01:00:00.000+00:00 itemprop=datePublished>2020-06-14</time></li><li class="block sm:inline-block mr-3"><a class="text-lg font-light" href=https://xuanwo.io/tags/golang><span>#golang</span></a></li></ul></header><div class=post-content><p>在开发 <a href=https://github.com/Xuanwo/storage>storage</a> 库的过程中，我设计并实现了一套 Golang 错误处理的规范。原始的提案和规范可以参考 <a href=https://storage.xuanwo.io/design/11-error-handling.html>Proposal: Error Handling</a> 与 <a href=https://storage.xuanwo.io/spec/1-error-handling.html>Spec: Error Handling</a>，本文是两者汇总后重新梳理的产物。</p><h2 id=tldr>TL;DR</h2><ul><li>区分 <code>预期</code> 与 <code>非预期</code> 错误</li><li>定义所有预期错误，返回所有的非预期错误</li><li>总是返回自定义错误类型以携带与错误上下文有关的信息，该类型必须实现 <code>xerrors.Wrapper</code> 接口</li><li>使用 <code>errors.Is</code> 来判断错误，使用 <code>errors.As</code> 来获取错误上下文</li></ul><hr><h2 id=定义>定义</h2><ul><li><code>错误</code>：不管是错误，故障，异常，失效抑或其他近义词汇，只要程序运行不符合预期，下文统称为 <code>错误</code></li><li><code>包</code>: 所有有效的 golang <code>package</code></li><li><code>实现者</code>：负责实现一个 <code>包</code> 的开发者</li><li><code>调用者</code>：负责调用一个 <code>包</code> 的开发者</li></ul><h2 id=目标>目标</h2><p>一个好的错误处理机制应该是这样的：</p><ul><li>实现者不需要做额外的工作，只需要专注于处理包自身的错误</li><li>调用者能够知道发生了什么错误</li><li>调用者能够决定如何处理这个错误</li><li>调用者能够了解为什么会发生这个错误</li></ul><h2 id=设计>设计</h2><p>从一个包的角度来看，能够将错误分为两类：<code>预期</code> 与 <code>非预期</code> 。</p><ul><li><code>预期</code>错误：实现者预期可能会出现并能处理的错误<ul><li>比如在解析 Protocol 时，返回 <code>ErrUnsupportedProtocol</code> 表示该 Protocol 尚未支持</li><li>所有的预期错误都必须提前声明</li><li>预期错误属于当前包，只有在当前包中才能返回，不允许直接返回其他包定义的预期错误</li></ul></li><li><code>非预期</code>错误：实现者不知道为何会出现或者无法处理的错误<ul><li>比如调用其他包返回的错误</li><li>所有的非预期错误实现者都不需要处理</li></ul></li></ul><p>无论是何种错误，在返回时都必须被包裹在自定义的错误类型中，该类型需要实现 <code>error</code> 和 <code>xerrors.Wrapper</code> 接口并携带充足的上下文信息：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#007020;font-weight:700>var</span> (
	<span style=color:#60a0b0;font-style:italic>// ErrSegmentPartsEmpty means segment&#39;s parts is empty
</span><span style=color:#60a0b0;font-style:italic></span>	ErrSegmentPartsEmpty = errors.<span style=color:#06287e>New</span>(<span style=color:#4070a0>&#34;segment part empty&#34;</span>)
)

<span style=color:#007020;font-weight:700>type</span> Error <span style=color:#007020;font-weight:700>struct</span> {
    Op  <span style=color:#902000>string</span>
    Err <span style=color:#902000>error</span>

    Seg <span style=color:#666>*</span>Segment
}

<span style=color:#007020;font-weight:700>func</span> (e <span style=color:#666>*</span>Error) <span style=color:#06287e>Error</span>() <span style=color:#902000>string</span> {
	<span style=color:#007020;font-weight:700>return</span> fmt.<span style=color:#06287e>Sprintf</span>(<span style=color:#4070a0>&#34;%s: %v: %s&#34;</span>, e.Op, e.Seg, e.Err)
}

<span style=color:#007020;font-weight:700>func</span> (e <span style=color:#666>*</span>Error) <span style=color:#06287e>Unwrap</span>() <span style=color:#902000>error</span> {
	<span style=color:#007020;font-weight:700>return</span> e.Err
}
</code></pre></div><ul><li><p>一般的，可以使用 <code>Op</code> 表示什么操作触发了这个错误，使用 <code>Err</code> 来携带原始错误。</p><ul><li><p>如果是预期错误，那 <code>Err</code> 应当是提前声明好的 <code>error</code></p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#007020;font-weight:700>return</span> <span style=color:#666>&amp;</span>Error{<span style=color:#4070a0>&#34;parse&#34;</span>, s[<span style=color:#40a070>0</span>], <span style=color:#007020;font-weight:700>nil</span>, ErrUnsupportedProtocol}
</code></pre></div></li><li><p>如果是非预期错误，那 <code>Err</code> 应当是未被修改的原始错误或者实现了 <code>xerrors.Wrapper</code> 接口的自定义错误</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>port, err <span style=color:#666>:=</span> strconv.<span style=color:#06287e>ParseInt</span>(s[<span style=color:#40a070>2</span>], <span style=color:#40a070>10</span>, <span style=color:#40a070>64</span>)
<span style=color:#007020;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:#007020;font-weight:700>nil</span> {
    <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020;font-weight:700>nil</span>, <span style=color:#666>&amp;</span>Error{<span style=color:#4070a0>&#34;parse&#34;</span>, ProtocolHTTP, s[<span style=color:#40a070>1</span>:], err}
}
</code></pre></div></li></ul></li><li><p>自定义错误类型中出现的 <code>ContextX</code> 类型应当尽可能的实现 <code>String() string</code> 方法</p></li><li><p>同一个项目中需要统一 <code>Error() string</code> 返回的字符串格式</p><ul><li>在 <a href=https://github.com/Xuanwo/storage>storage</a> 项目中，我选择的格式是 <code>{Op}: {ContextA}, {ContextB}: {Err}</code></li></ul></li><li><p><code>Unwrap() error</code> 方法中，应当直接返回 <code>Err</code> 并不做任何修改</p></li></ul><p>调用者可以自行决定如何使用包返回的错误：</p><ul><li>直接返回给上层应用<div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#007020;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:#007020;font-weight:700>nil</span> {
  <span style=color:#007020;font-weight:700>return</span> err
}
</code></pre></div></li><li>处理特定的错误<div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#007020;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:#007020;font-weight:700>nil</span> <span style=color:#666>&amp;&amp;</span> errors.<span style=color:#06287e>Is</span>(err, segment.ErrSegmentPartsEmpty) {
  log.<span style=color:#06287e>Print</span>(<span style=color:#4070a0>&#34;segment is empty&#34;</span>)
}
</code></pre></div></li><li>获取错误的上下文信息<div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#007020;font-weight:700>var</span> e segment.Error
<span style=color:#007020;font-weight:700>if</span> err <span style=color:#666>!=</span> <span style=color:#007020;font-weight:700>nil</span> <span style=color:#666>&amp;&amp;</span> errors.<span style=color:#06287e>As</span>(err, <span style=color:#666>&amp;</span>e) {
    log.<span style=color:#06287e>Print</span>(e.Segment)
}
</code></pre></div></li></ul><h2 id=参考资料>参考资料</h2><ul><li><a href=https://storage.xuanwo.io/design/11-error-handling.html>storage Proposal: Error Handling</a></li><li><a href=https://storage.xuanwo.io/spec/1-error-handling.html>storage Spec: Error Handling</a></li><li><a href=https://blog.golang.org/error-handling-and-go>Go Blog: Error handling and Go</a></li><li><a href=https://blog.golang.org/go1.13-errors>Go Blog: Working with Errors in Go 1.13</a></li><li><a href=http://joeduffyblog.com/2016/02/07/the-error-model/>The Error Model in Midori</a></li></ul></div></article></main><footer><div class=container><div class="flex flex-col md:flex-row justify-between py-4"><div class="flex-shrink-0 flex flex-wrap md:w-1/3 mt-4 md:mt-0"><span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/archives/>归档</a></span>
<span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/categories/>分类</a></span>
<span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/tags/>标签</a></span>
<span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/series/>系列</a></span>
<span class="flex-shrink-0 w-1/5 mb-2 text-center lg:text-left"><a class="footer-link relative text-gray-500 hover:text-gray-100 hover:no-underline" href=/blogroll/>友链</a></span></div><ul class="flex sm:w-1/2 md:w-1/3 text-center lg:text-right"><li class=w-1/4><a class="text-gray-500 hover:text-gray-800" href=/index.xml><i class="fas fa-rss"></i></a></li><li class=w-1/4><a class="text-gray-500 hover:text-gray-800" href=https://github.com/Xuanwo><i class="fas fa-github"></i></a></li><li class=w-1/4><a class="text-gray-500 hover:text-gray-800" href=https://t.me/xuanwo_read_later><i class="fas fa-telegram-plane"></i></a></li><li class=w-1/4><a class="text-gray-500 hover:text-gray-800" href=https://twitter.com/OnlyXuanwo><i class="fas fa-twitter"></i></a></li></ul></div></div><script src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.js integrity="sha256-KiHRWUnyloQ6hvdcRAfi7hwExmviOdyWTRFBLmDNhHc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js integrity="sha256-YVWQosorZnr6fALvOW9VALYuInld27RkSPkElGBdCaU=" crossorigin=anonymous></script><script defer src=/javascript/algolia_search.min.78d1e38d6ad73f7bc248762cbf4f70b246476baa3288e2a780ec7ac11f0e669d.js integrity=sha256-eNHjjWrXP3vCSHYsv09wskZHa6oyiOKngOx6wR8OZp0=></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-51515330-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></footer></body></html>